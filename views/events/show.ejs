<%-include("../partials/header") %>

<%-include("../partials/dropdown") %>

<%-include("../partials/flash") %>

<!-- Embed server-side JSON-LD for SEO -->
  <script type="application/ld+json">
    <%= JSON.stringify(jsonld, null, 2) %>
  </script>

  <div style="background-image: url('<%= event.image %>');" class="hero">
    <h1><%= event.title.charAt(0).toUpperCase() + event.title.slice(1) %></h1>
  </div>

  <div class="container">

    <script>
  // Parse query params
  const params = new URLSearchParams(window.location.search);
  const shareRef = params.get("shareRef");
  const promoterRef = params.get("promoterRef");

  if (shareRef) {
    // Persist to localStorage as a fallback (and survive page reloads)
    localStorage.setItem("shareAttribution", JSON.stringify({
      shareRef,
      promoterRef,
      capturedAt: Date.now()
    }));

    // Optionally ping backend so session gets the attribution immediately
    fetch("/capture-attribution", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include", // important if using session cookies
      body: JSON.stringify({ shareRef, promoterRef })
    }).catch(() => {
      // ignore failures; backend can also pick it up later from form submission
    });
  }
</script>


    <div class="info">
      <h2>Event Details</h2>

      <p><strong>Date:</strong> <%= new Date(event.date).toDateString() %></p>
      <p><strong>Location:</strong> <%= event.location %></p>

      <% if (event.category) { %>
        <div class="tags">
          <span class="tag"><%= event.category.charAt(0).toUpperCase() + event.category.slice(1) %></span>
        </div>
      <% } %>

      <div class="countdown" id="countdown"></div>

      <p><%= event.description %></p>

      <div class="actions">
        <% if (user && user._id.toString() === event.created_by._id.toString()) { %>
          <!-- Owner View -->
          <button onclick="navigator.share ? navigator.share({ title: '<%= event.title %>', url: window.location.href }) : alert('Share not supported')">Share</button>

          <% if (!event.promotionExpires || new Date(event.promotionExpires) < new Date()) { %>
            <a href="/promoteItem/<%= event.type %>/<%= event._id %>">
              <button type="button">Promote Event</button>
            </a>
          <% } %>
<style media="screen">
/* Sidebar container */
#sidebar {
  width: 250px;
  background: #fff;
  border-right: 1px solid #ddd;
  display: flex;
  flex-direction: column;
  position: fixed;
  inset: 0 auto 0 0;
  z-index: 30;
  overflow-y: auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

/* Header */
#sidebar-header {
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-bottom: 1px solid #ddd;
  padding: 0 16px;
}

.sidebar-logo {
  display: flex;
  align-items: center;
}

.sidebar-logo-icon {
  width: 40px;
  height: 40px;
  color: #2563eb; /* blue */
}

.sidebar-logo-text {
  margin-left: 12px;
  font-size: 20px;
  font-weight: bold;
  color: #333;
}

/* Menu */
#sidebar-menu {
  flex-grow: 1;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.sidebar-link {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  border-radius: 8px;
  color: #555;
  font-size: 14px;
  text-decoration: none;
  transition: background 0.3s, color 0.3s;
}

.sidebar-link .sidebar-icon {
  font-size: 18px;
  margin-right: 10px;
  color: #666;
}

.sidebar-link:hover {
  background: #2563eb;
  color: #fff;
}

.sidebar-link:hover .sidebar-icon {
  color: #fff;
}

.sidebar-link.active {
  background: #2563eb;
  color: #fff;
}

/* Footer */
#sidebar-footer {
  margin-top: auto;
  padding: 15px;
  border-top: 1px solid #ddd;
}

.profile {
  display: flex;
  align-items: center;
}

.profile-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}

.profile-info {
  margin-left: 10px;
}

.profile-name {
  font-size: 14px;
  font-weight: 600;
  color: #333;
}

.profile-role {
  font-size: 12px;
  color: #777;
}

/* Logout button */
.logout-btn {
  margin-top: 12px;
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: transparent;
  color: #555;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s;
}

.logout-btn:hover {
  background: #f3f3f3;
}

.logout-icon {
  margin-right: 6px;
  font-size: 16px;
}

</style>

          <a href="/edit/<%= event._id %>"><button>Edit</button></a>
          <a href="/delete/<%= event._id %>"><button type="submit" onclick="return confirm('Are you sure you want to delete this event?')">Delete</button></a>
        <% } else { %>
          <a href="/book/event/<%= event._id %>"><button>Book Now</button></a>
          <div class="share-wrapper" data-event-id="<%= event._id %>">
            <button type="button" class="shareBtn" data-title="<%= event.title %>">
              Share
            </button>
          </div>
        <% } %>
      </div>

      <!-- <h1><%= event.title %></h1>
      <p><%= shareCount %></p>

      <h3>Shared By</h3>
      <ul>
        <% if (promoters.length === 0) { %>
          <li>No one has shared this event yet.</li>
        <% } else { %>
          <% promoters.forEach(promoter => { %>
            <li>
              <strong><%= promoter.promoted_by?.username || 'Guest' %></strong>
              shared from IP: <%= promoter.ip %> |
              Agent: <%= promoter.userAgent %> |
              at <%= promoter.createdAt?.toLocaleString() %>
            </li>
          <% }) %>
        <% } %>
      </ul> -->

        <script>
          // attach listener (works even if multiple on page)
          document.querySelectorAll(".shareBtn").forEach(btn => {
            btn.addEventListener("click", async () => {
              const wrapper = btn.closest(".share-wrapper");
              const eventId = (wrapper && wrapper.dataset && wrapper.dataset.eventId) || "";
              const title = btn.dataset.title || document.title;
              if (!eventId) return alert("Event ID missing");

              try {
                const res = await fetch(`/share/${eventId}`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include" // ensure session cookie if auth is cookie-based
                });

                if (!res.ok) {
                  const err = await res.json().catch(() => ({}));
                  return alert(err.error || "Failed to generate share link");
                }

                const data = await res.json();
                const shareUrl = data.shareUrl;
                if (!shareUrl) return alert("No share URL returned");

                const sharePayload = { title, url: shareUrl };

                if (navigator.share) {
                  navigator.share(sharePayload).catch(() => {
                    navigator.clipboard.writeText(shareUrl);
                    alert("Share link copied: " + shareUrl);
                  });
                } else {
                  await navigator.clipboard.writeText(shareUrl);
                  alert("Share link copied: " + shareUrl);
                }
              } catch (err) {
                console.error("Share error:", err);
                alert("Error creating share link");
              }
            });
          });
        </script>

        <div class="profile-grid">
          <!-- Organizer Card -->
          <a href="/organizer/<%= event.created_by._id %>">
            <div class="profile-card">
              <img src="<%= event.created_by?.profile_image || '/images/default-organizer.jpg' %>" alt="Organizer Photo" class="profile-image" />
              <div class="profile-stats">
                 <span class="stat"><%= totalEvents %> <span>Events created</span> </span>
                 <span class="stat"><%= event.created_by?.followers || '0'%> <span>Followers</span> </span>
                 <span class="stat"><%= event.created_by?.reviews || '4.5' %> <span>★ Rating</span> </span>
              </div>
              <div class="insider">
              <h4>Created by: <%= event.created_by?.username || 'Classic Event' %></h4>
              <p><strong>Role:</strong> <%= event.created_by?.role || 'Classic Events' %></p>
              <p><strong>Generic:</strong> <%= event.created_by?.generic || 'General' %></p>
              </div>
              <div class="social-links">
                <% if (event.created_by?.facebook) { %><a href="<%= event.created_by.facebook %>" target="_blank"><i class="fab fa-facebook"></i></a><% } %>
                <% if (event.created_by?.instagram) { %><a href="<%= event.created_by.instagram %>" target="_blank"><i class="fab fa-instagram"></i></a><% } %>
                <% if (event.created_by?.website) { %><a href="<%= event.created_by.website %>" target="_blank"><i class="fas fa-globe"></i></a><% } %>
              </div>
            </div>
          </a>

          <!-- Promoter Card -->
          <% if (event.promoted_by) { %>

            <a href="/promoter/<%= event.promoted_by._id %>">
              <div class="profile-card">
                <img src="<%= event.promoted_by.profile_image || '/images/default-organizer.jpg' %>" alt="Organizer Photo" class="profile-image" />
                <div class="profile-stats">
                   <span class="stat"><%= totalEventShared %> <span>Events promoted</span> </span>
                   <span class="stat"><%= event.promoted_by.followers || '0' %> <span>Followers</span> </span>
                   <span class="stat"><%= event.promoted_by.reviews || '4.5' %> <span>★ Rating</span> </span>
                </div>
                <div class="insider">
                  <h4>Promoted by: <%= event.promoted_by.username || 'Classic Event' %></h4>
                  <p><strong>Role:</strong> <%= event.promoted_by.role || 'Classic Events' %></p>
                  <p><strong>Generic:</strong> <%= event.promoted_by.generic || 'General' %></p>
                </div>
                <div class="social-links">
                  <% if (event.promoted_by.facebook) { %><a href="<%= event.promoted_by.facebook %>" target="_blank"><i class="fab fa-facebook"></i></a><% } %>
                  <% if (event.promoted_by.instagram) { %><a href="<%= event.promoted_by.instagram %>" target="_blank"><i class="fab fa-instagram"></i></a><% } %>
                  <% if (event.promoted_by.website) { %><a href="<%= event.promoted_by.website %>" target="_blank"><i class="fas fa-globe"></i></a><% } %>
                </div>
              </div>
            </a>
          <% } %>

        </div>

      <div class="faq">
        <h3>FAQs</h3>
        <p><strong>What should I bring?</strong> A printed or digital ticket and a valid ID.</p>
        <p><strong>Are kids allowed?</strong> Yes, under adult supervision.</p>
      </div>


      <div class="map">
        <iframe width="100%" height="250" style="border-radius: 10px" loading="lazy" allowfullscreen src="https://www.google.com/maps?q=<%= encodeURIComponent(event.location) %>&output=embed"></iframe>
      </div>

      <div class="event-header">
        <h2>Events by the same organizer</h2>
      </div>

      <div class="profile-grid">

        <% otherEventsByOrganizer.forEach(event => { %>
          <div class="profile-card">
            <img src="<%= event.image || 'https://via.placeholder.com/400x250' %>" alt="<%= event.title %>" class="profile-image" />

            <div class="button-row">
              <!-- Profile image -->
              <div class="profile-img">
                <img src="https://via.placeholder.com/40" alt="Profile">
              </div>

              <!-- Stats: views, likes, shares -->
              <div class="right-buttons">
                <div class="stat">
                  <div class="stat-count">1.2k</div>
                  <i class="fa-solid fa-eye stat-icon"></i>
                </div>

                <div class="stat" onclick="toggleLike(this)">
                  <div class="stat-count" id="likeCount"><%= event.views %></div>
                  <i class="fa-regular fa-heart stat-icon heart"></i>
                </div>

                <div class="stat">
                  <div class="stat-count">89</div>
                  <i class="fa-solid fa-share stat-icon"></i>
                </div>
              </div>
            </div>

            <div class="card-body">
              <h3><%= event.title?.slice(0, 55) %>....</h3>
              <p>📅 <%= new Date(event.date).toDateString() %> |
                <i style="font-size: 14px; margin-left: 5px;" class="fa fa-map-marker" aria-hidden="true"></i>
                <%= event.location %>
              </p>

              <% if (event.is_free) { %>
                <p>🎟️ Free</p>
              <% } else {
                  const cheapest = event.ticket_types.reduce((min, ticket) => ticket.current_price < min ? ticket.current_price : min, event.ticket_types[0].current_price);
                  const totalSold = event.ticket_types.reduce((sum, ticket) => sum + ticket.sold, 0);
                  const totalAvailable = event.ticket_types.reduce((sum, ticket) => sum + ticket.total_available, 0);
                  const ticketsLeft = totalAvailable - totalSold;
              %>
                <p>💸 From $<%= cheapest %> | 🔥 Only <%= ticketsLeft %> left</p>
              <% } %>

              <div class="actionbtn">
                <a class="bookingbtn" href="/book/event/<%= event._id %>">Book ticket</a>
                <a class="detailsbtn" href="/show/<%= event.type %>/<%= event._id %>">View details</a>
              </div>
            </div>
          </div>
        <% }); %>
      </div>


    </div>

    <div class="ticket-section">

      <h3>🎟️ Ticket Options</h3>

      <% event.ticket_types.forEach(t => {
         const available = t.total_available - t.sold;
      %>
      <div class="ticket">
        <span><%= t.type.toUpperCase() %></span> -
        $<%= t.current_price %>
        <% if (available <= 0) { %>
          <span style="color: red;">(Sold Out)</span>
        <% } else { %>
          (Available: <%= available %>)
        <% } %>

      </div>

      <% }) %>


      <% const ratingValue = existingRating ? parseInt(existingRating.rating || 0) : 0; %>

      <div class="rating-card">
        <h2><%= existingRating && existingRating._id ? 'Edit Your Rating' : 'Rate This Event' %></h2>
        <form action="/rateEvent/<%= event._id %>" method="POST" id="ratingForm">
          <div class="stars" id="starRating">
            <% for (let i = 1; i <= 5; i++) { %>
              <span
                class="star <%= i <= ratingValue ? 'selected' : '' %>"
                data-value="<%= i %>">&#9733;</span>
            <% } %>
          </div>

          <input type="hidden" name="rating" id="ratingValue" value="<%= ratingValue %>">
          <textarea
            name="comment"
            id="feedback"
            rows="4"
            placeholder="Tell us what you think..."
            required><%= existingRating && existingRating.comment ? existingRating.comment : '' %></textarea>

          <button class="btn" type="submit">
            <%= existingRating && existingRating._id ? 'Update Rating' : 'Submit Rating' %>
          </button>
        </form>
      </div>

      <script>
        const stars = document.querySelectorAll('.star');
        const ratingInput = document.getElementById('ratingValue');

        stars.forEach(star => {
          star.addEventListener('click', () => {
            const value = parseInt(star.getAttribute('data-value'));
            ratingInput.value = value;

            stars.forEach(s => {
              const sVal = parseInt(s.getAttribute('data-value'));
              s.classList.toggle('selected', sVal <= value);
            });
          });
        });

      </script>

      <style>
        .star {
          font-size: 24px;
          cursor: pointer;
          color: gray;
          transition: color 0.2s ease;
        }
        .star.selected {
          color: gold;
        }
      </style>

      <div class="rating-card">
        <div class="average-rating">
          <% const fullStars = Math.floor(averageRating); %>
          <% const halfStar = averageRating % 1 >= 0.5; %>
          <% const emptyStars = 5 - fullStars - (halfStar ? 1 : 0); %>

          <% for (let i = 0; i < fullStars; i++) { %>⭐<% } %>
          <% if (halfStar) { %>✬<% } %>
          <% for (let i = 0; i < emptyStars; i++) { %>☆<% } %>

          <span><%= averageRating.toFixed(1) %> out of 5</span>
        </div>

        <h3>User Reviews</h3>
        <ul class="review-list" id="reviewList">
          <% if (reviews && reviews.length > 0) { %>
            <% reviews.forEach(review => { %>
              <li class="review-item">
                <div class="name"><%= review.userName %></div>
                <div><%= review.comment %></div>
              </li>
            <% }); %>
          <% } else { %>
            <li class="review-item">
              <div>No reviews yet. Be the first to leave a comment!</div>
            </li>
          <% } %>
        </ul>
      </div>

      <div class="event-header">
        <h2>Related Events</h2>
      </div>

      <div class="profile-grid-events">

        <% events.forEach(event => { %>
          <div class="profile-card">
            <img src="<%= event.image || 'https://via.placeholder.com/400x250' %>" alt="<%= event.title %>" class="profile-image" />

            <div class="button-row">
              <!-- Profile image -->
              <div class="profile-img">
                <img src="https://via.placeholder.com/40" alt="Profile">
              </div>

              <!-- Stats: views, likes, shares -->
              <div class="right-buttons">
                <div class="stat">
                  <div class="stat-count">1.2k</div>
                  <i class="fa-solid fa-eye stat-icon"></i>
                </div>

                <div class="stat" onclick="toggleLike(this)">
                  <div class="stat-count" id="likeCount"><%= event.views %></div>
                  <i class="fa-regular fa-heart stat-icon heart"></i>
                </div>

                <div class="stat">
                  <div class="stat-count">89</div>
                  <i class="fa-solid fa-share stat-icon"></i>
                </div>
              </div>
            </div>

            <div class="card-body">
              <h3><%= event.title?.slice(0, 55) %>....</h3>
              <p>📅 <%= new Date(event.date).toDateString() %> |
                <i style="font-size: 14px; margin-left: 5px;" class="fa fa-map-marker" aria-hidden="true"></i>
                <%= event.location %>
              </p>

              <% if (event.is_free) { %>
                <p>🎟️ Free</p>
              <% } else {
                  const cheapest = event.ticket_types.reduce((min, ticket) => ticket.current_price < min ? ticket.current_price : min, event.ticket_types[0].current_price);
                  const totalSold = event.ticket_types.reduce((sum, ticket) => sum + ticket.sold, 0);
                  const totalAvailable = event.ticket_types.reduce((sum, ticket) => sum + ticket.total_available, 0);
                  const ticketsLeft = totalAvailable - totalSold;
              %>
                <p>💸 From $<%= cheapest %> | 🔥 Only <%= ticketsLeft %> left</p>
              <% } %>

              <div class="actionbtn">
                <a class="bookingbtn" href="/book/event/<%= event._id %>">Book ticket</a>
                <a class="detailsbtn" href="/show/<%= event.type %>/<%= event._id %>">View details</a>
              </div>
            </div>
          </div>
        <% }); %>
      </div>


      <!-- services start -->
     <div class="profile-grid-events">
      <%-include("../services/main-page-services.ejs") %>
     </div>
      <!-- services end -->


    </div>

    <script>
      const stars = document.querySelectorAll('.star');
      let selectedRating = 0;

      stars.forEach(star => {
        star.addEventListener('click', () => {
          selectedRating = star.dataset.value;
          updateStars(selectedRating);
        });

        star.addEventListener('mouseover', () => {
          updateStars(star.dataset.value, true);
        });

        star.addEventListener('mouseout', () => {
          updateStars(selectedRating);
        });
      });

      function updateStars(value, isHover = false) {
        stars.forEach(star => {
          star.classList.remove('selected', 'hover');
          if (star.dataset.value <= value) {
            star.classList.add(isHover ? 'hover' : 'selected');
          }
        });
      }

      function submitRating() {
        const feedback = document.getElementById('feedback').value.trim();
        if (selectedRating === 0 || feedback === "") {
          alert("Please select a rating and provide your feedback.");
          return;
        }

        const reviewList = document.getElementById('reviewList');
        const li = document.createElement('li');
        li.classList.add('review-item');
        li.innerHTML = `<div class="name">You</div><div>${feedback}</div>`;
        reviewList.prepend(li);

        document.getElementById('feedback').value = '';
        updateStars(0);
        selectedRating = 0;
      }
    </script>

    </div>
  </div>

  <script>
    const countdownElement = document.getElementById('countdown');
    const eventDate = new Date("2025-07-20T00:00:00Z").getTime();

    const updateCountdown = () => {
      const now = new Date().getTime();
      const diff = eventDate - now;
      if (diff <= 0) {
        countdownElement.textContent = "Event is live now!";
        return;
      }
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      countdownElement.textContent = `Starts in: ${days}d ${hours}h ${minutes}m`;
    };
    setInterval(updateCountdown, 60000);
    updateCountdown();
  </script>


<%-include("../partials/footer") %>
